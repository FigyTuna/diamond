<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Diamond Game</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: #303030;
		}
	</style>
	<script src="pixi.js"></script>
</head>
<body>
	<script>
		var stage = new PIXI.Stage(0x505050);
		var renderer = PIXI.autoDetectRenderer(1000, 600);
		document.body.appendChild(renderer.view);
		requestAnimFrame(animate);

		//------------------------------------ TEXTURES

		var personTexture = PIXI.Texture.fromImage("images/guy.png");

		var tileTexture = PIXI.Texture.fromImage("images/tile.png");

		var underTexture = PIXI.Texture.fromImage("images/under.png");

		//----------------------------------- MOVEMENT VARIABLES

		var area = new PIXI.DisplayObjectContainer();
		stage.addChild(area);

		var size = 10;//FINAL
		var start = 100;//Depends on other things. Should be centered. Scrolling landscapes too.

		var left = false;
		var up = false;
		var right = false;
		var down = false;

		var lr = 0;
		var ud = 0;

		var speed = 3;

		//------------------------------------- TEMP VARIABLES

		var map = new Array(size);
		for(var i = 0; i < map.length; i++){
			map[i] = new Array(size);
		}
		for(var i = 0; i < map.length; i++){
			for(var j = 0; j < map[0].length; j++){
				map[i][j] = 0;
			}
		}
		for(var i = map.length; i > 0; i--){
			map[1][i] = i;
		}
		map[9][9] = 3;
		map[5][6] = 2;
		map[6][6] = 1;
		map[5][5] = 3;
		map[6][5] = 2;

		//------------------------------------- TILES

		var levels = new Array(50); //Some large number
		for(var i = 0; i < 50; i++){
			levels[i] = new PIXI.DisplayObjectContainer();
		}

		drawMap();

		//--------------------------------------- PERSON

		var person = new PIXI.Sprite(personTexture);

		var guyx = 250;
		var guyy = 150;

		person.anchor.x = 0.5;
		person.anchor.y = 1;

		person.position.x = guyx;
		person.position.y = guyy;

		area.addChild(person);

		//-------------------------------------------- INPUT

		document.addEventListener('keydown', function(event){
			var code = event.keyCode;

			if(code == 65){ //A
				left = true;
			}
			if(code == 87){ //W
				up = true;
			}
			if(code == 68){ //D
				right = true;
			}
			if(code == 83){ //S
				down = true;
			}

		})

		document.addEventListener('keyup', function(event){
			var code = event.keyCode;

			if(code == 65){ //A
				left = false;
			}
			if(code == 87){ //W
				up = false;
			}
			if(code == 68){ //D
				right = false;
			}
			if(code == 83){ //S
				down = false;
			}
		})

		//--------------------------------------------------------------------- GAME LOOP

		function animate(){
			requestAnimFrame(animate);

			movement();
			update();

			renderer.render(stage);
		}

		function update(){

			//Person
			var offset = 0;
			var ci = 0;
			var cj = 0;
			var close = 1000;
			for(var i = 0; i < map.length; i++){
				for(var j = 0; j < map.length; j++){
					var distance = Math.abs((map.length - 1 + i - j) * 30 + start - guyx) + (Math.abs((i + j) * 20 + start - guyy) * 1.5);
					if(distance < close && distance < 60){
						ci = i;
						cj = j;
						close = distance;
					}
				}
			}
			offset = 12 * map[ci][cj];

			person.position.x = guyx; //Useless for now.
			person.position.y = guyy - offset;

			//Map and layers
			while(area.children.length > 0){
				area.removeChild(area.getChildAt(0));
			}
			for(var i = 0; i < 50; i++){ //<
				if(i <= ci + cj){
					area.addChild(levels[i]);
				}else if(i == ci + cj + 1){
					area.addChild(person);
				}else{
					area.addChild(levels[i - 1]);
				}
			}
		}

		//----------------------------------------------- MOVEMENT

		function movement(){
			guyx += lr;
			guyy += ud;

			if(left){
				lr = -speed;
			}
			if(up){
				ud = -speed;
			}
			if(right){
				lr = speed;
			}
			if(down){
				ud = speed;
			}

			lr /= 1.35;
			ud /= 1.35;
		}

		function drawMap(){
			for(var i = 0; i < map.length; i++){
				for(var j = 0; j < map.length; j++){
					var tile = new PIXI.Sprite(tileTexture);

					tile.anchor.x = tile.anchor.y = 0.5;

					tile.position.x = (size - 1 + i - j) * 30 + start;
					tile.position.y = (i + j) * 20 + start - (12 * map[i][j]); //-12 under height.

					levels[i + j].addChild(tile);

					for(var k = map[i][j]; k > 0; k--){
						if(i == map.length - 1 || k > map[i+1][j]){
							var under = new PIXI.Sprite(underTexture);

							under.anchor.x = tile.anchor.y = 0.5;

							under.position.x = (size - 1 + i - j) * 30 + start + 15; // +15 offset to right.
							under.position.y = (i + j) * 20 + start - (12 * k); //-12 to be changed.

							levels[i + j].addChild(under);
						}

						if(j == map.length - 1 || k > map[i][j+1]){
							var under2 = new PIXI.Sprite(underTexture);

							under2.anchor.x = tile.anchor.y = 0.5;

							under2.scale.x = -1;

							under2.position.x = (size - 1 + i - j) * 30 + start - 15; // -15 offset to left.
							under2.position.y = (i + j) * 20 + start - (12 * k); //-12 to be changed.

							levels[i + j].addChild(under2);
						}
					}
				}
			}
			for(var i = 0; i < 50; i++){ //<
				area.addChild(levels[i]);
			}
		}
	</script>
</body>
