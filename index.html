<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Diamond Game</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: #303030;
		}
	</style>
	<script src="pixi.js"></script>
</head>
<body>
	<script>
		var stage = new PIXI.Stage(0x505050);
		var renderer = PIXI.autoDetectRenderer(1000, 600);
		document.body.appendChild(renderer.view);
		requestAnimFrame(animate);

		//------------------------------------ TEXTURES

		var personTexture = PIXI.Texture.fromImage("images/character/guy.png");

		var tileTexture = PIXI.Texture.fromImage("images/tile/grass/top.png");

		var underTexture = PIXI.Texture.fromImage("images/tile/grass/side.png");

		var objTexture = PIXI.Texture.fromImage("images/object/tree.png");

		//----------------------------------- MOVEMENT VARIABLES

		var area = new PIXI.DisplayObjectContainer();
		stage.addChild(area);

		var size = 14;//FINAL
		var start = 100;//Depends on other things. Should be centered. Scrolling landscapes too.
		var tileWidth = 50;
		var tileHeight = 24;

		var left = false;
		var up = false;
		var right = false;
		var down = false;

		var lr = 0;
		var ud = 0;

		var lastZi = 0;
		var lastZj = 0;

		var speed = 3;

		//------------------------------------- TEMP MAP

		var map = new Array(size);
		for(var i = 0; i < map.length; i++){
			map[i] = new Array(size);
		}
		for(var i = 0; i < map.length; i++){
			for(var j = 0; j < map[0].length; j++){
				map[i][j] = 0;
			}
		}
		for(var i = map.length - 2; i > 0; i--){
			map[1][i] = i;
			map[i][1] = i;
		}
		map[2][2] = 1;

		map[9][9] = 3;

		map[5][6] = 2;
		map[6][6] = 1;
		map[5][5] = 3;
		map[6][5] = 2;

		map[5][2] = 2;
		map[6][2] = 2;
		map[6][3] = 2;

		//---- Object map

		var map2 = new Array(map.length);
		for(var i = 0; i < map2.length; i++){
			map2[i] = new Array(map.length);
		}
		for(var i = 0; i < map2.length; i++){
			for(var j = 0; j < map2[0].length; j++){
				map2[i][j] = 0; // Should be set to object objects as well as tiles to tile objects
			}
		}
		map2[0][0] = 1;
		map2[6][9] = 1;
		map2[7][9] = 1;
		map2[7][10] = 1;

		//---------------------------- Map things

		var levels = new Array(50); //Some large number
		for(var i = 0; i < 50; i++){
			levels[i] = new PIXI.DisplayObjectContainer();
		}
		var objMap = new Array(50);
		for(var i = 0; i < 50; i++){
			objMap[i] = new PIXI.DisplayObjectContainer();
		}

		//------------------------------------- TILES

		drawMap();

		//--------------------------------------- PERSON

		var person = new PIXI.Sprite(personTexture);

		var guyx = start * 3;
		var guyy = start * 3;

		person.anchor.x = 0.5;
		person.anchor.y = 1;

		person.position.x = guyx;
		person.position.y = guyy;

		area.addChild(person);

		//-------------------------------------------- INPUT

		document.addEventListener('keydown', function(event){
			var code = event.keyCode;

			if(code == 65 || code == 37){ //A
				left = true;
			}
			if(code == 87 || code == 38){ //W
				up = true;
			}
			if(code == 68 || code == 39){ //D
				right = true;
			}
			if(code == 83 || code == 40){ //S
				down = true;
			}

		})

		document.addEventListener('keyup', function(event){
			var code = event.keyCode;

			if(code == 65 || code == 37){ //A
				left = false;
			}
			if(code == 87 || code == 38){ //W
				up = false;
			}
			if(code == 68 || code == 39){ //D
				right = false;
			}
			if(code == 83 || code == 40){ //S
				down = false;
			}
		})

		//--------------------------------------------------------------------- GAME LOOP

		function animate(){
			requestAnimFrame(animate);

			update();

			renderer.render(stage);
		}

		function update(){

			//Movement

			if(left){
				lr = -speed;
			}
			if(up){
				ud = -speed * 0.5;
			}
			if(right){
				lr = speed;
			}
			if(down){
				ud = speed * 0.5;
			}
			if(left && right){
				lr = 0;
			}
			if(up && down){
				ud = 0;
			}

			guyx += lr;
			guyy += ud;

			// What tile
			var ci = 0;
			var cj = 0;
			var close = 1000;
			for(var i = 0; i < map.length; i++){
				for(var j = 0; j < map.length; j++){
					var distance = Math.abs((map.length - 1 + i - j) * (tileWidth/2) + start - guyx) + (Math.abs((i + j) * (tileHeight/2) + start - guyy) * 1.5);
					if(distance < close){
						ci = i;
						cj = j;
						close = distance;
					}
				}
			}

			//Collision correction
			//This part works but poorly.

			if(Math.abs(map[ci][cj] - map[lastZi][lastZj]) > 1 || ci > size || cj > size){
				guyx -= lr;
				guyy -= ud;
				if(!(ci != lastZi && cj != lastZj)){
					if(ci > lastZi){ // bottom right
						if(right && !down){
							guyx += speed;
							guyy += -speed * 0.55;
						}else if(down && !right){
							guyx += -speed;
							guyy += speed * 0.5;
						}
					}
					if(ci < lastZi){ // top left
						if(left && !up){
							guyx += -speed;
							guyy += speed * 0.55;
						}else if(up && !left){
							guyx += speed;
							guyy += -speed * 0.5;
						}
					}
					if(cj > lastZj){ // bottom left
						if(left && !down){
							guyx += -speed;
							guyy += -speed * 0.55;
						}else if(down && !left){
							guyx += speed;
							guyy += speed * 0.5;
						}
					}
					if(cj < lastZj){ // top right
						if(right && !up){
							guyx += speed;
							guyy += speed * 0.55;
						}else if(up && !right){
							guyx += -speed;
							guyy += -speed * 0.5;
						}
					}
				}

				ci = lastZi;
				cj = lastZj;
			}

			//Raising to correct height visually

			var offset = 9 * map[ci][cj];

			//Slow down

			lr /= 1.35;
			ud /= 1.35;

			if(Math.abs(lr) < 0.001){
				lr = 0;
			}
			if(Math.abs(ud) < 0.001){
				ud = 0;
			}

			//Person Placement

			person.position.x = guyx;
			person.position.y = guyy - offset;

			//Map and layers
			while(area.children.length > 0){
				area.removeChild(area.getChildAt(0));
			}
			for(var i = 0; i < 50; i++){ //<
				if(i <= ci + cj){
					area.addChild(levels[i]);
					area.addChild(objMap[i]);
				}else if(i == ci + cj + 1){
					if(guyy < (ci + cj) * (tileHeight/2) + start){ //This is what I was working on. Adding objects in the correct order.
						area.addChild(objMap[i]);
						area.addChild(person);
					}else{
						area.addChild(person);
						area.addChild(objMap[i]);
					}
				}else{
					area.addChild(levels[i - 1]);
					area.addChild(objMap[i - 1]);
				}
			}

			//Last
			lastZi = ci;
			lastZj = cj;
		}

		//Drawing

		function drawMap(){
			for(var i = 0; i < map.length; i++){
				for(var j = 0; j < map.length; j++){
					var tile = new PIXI.Sprite(tileTexture);

					tile.anchor.x = tile.anchor.y = 0.5;

					tile.position.x = (size - 1 + i - j) * (tileWidth/2) + start;
					tile.position.y = (i + j) * (tileHeight/2) + start - (9 * map[i][j]); //-12 under height.

					levels[i + j].addChild(tile);

					for(var k = map[i][j]; k > 0; k--){
						if(i == map.length - 1 || k > map[i+1][j]){
							var under = new PIXI.Sprite(underTexture);

							under.anchor.x = tile.anchor.y = 0.5;

							under.position.x = (size - 1 + i - j) * (tileWidth/2) + start + (tileWidth/4);
							under.position.y = (i + j) * (tileHeight/2) + start - (9 * k); //-12 to be changed.

							levels[i + j].addChild(under);
						}

						if(j == map.length - 1 || k > map[i][j+1]){
							var under2 = new PIXI.Sprite(underTexture);

							under2.anchor.x = tile.anchor.y = 0.5;

							under2.scale.x = -1;

							under2.position.x = (size - 1 + i - j) * (tileWidth/2) + start - (tileWidth/4);
							under2.position.y = (i + j) * (tileHeight/2) + start - (9 * k); //-12 to be changed.

							levels[i + j].addChild(under2);
						}
					}

					//Objects
					if(map2[i][j] == 1){ //Expand for more objects
						var obj = new PIXI.Sprite(objTexture);

						obj.anchor.x = 0.5
						obj.anchor.y = 1;

						obj.position.x = (size - 1 + i - j) * (tileWidth/2) + start;
						obj.position.y = (i + j) * (tileHeight/2) + start - (9 * map[i][j]);

						objMap[i + j].addChild(obj);
					}
				}
			}
		}
	</script>
</body>
